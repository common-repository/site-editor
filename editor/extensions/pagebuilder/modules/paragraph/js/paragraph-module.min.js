(function( exports, $ ) {
    var api = sedApp.editor;
    api.initParagraphsEditors = [];

    $( function() {

        $(".sed-pb-post-container-disable-editing").find('.sed-paragraph').addClass('sed-paragraph-no-editable').removeClass('sed-paragraph');

        $(".sed-paragraph").each( function(){

            var elId = $(this).attr("sed_model_id");

            api.initParagraphsEditors.push( elId );

        });

        var _mceAddEditor = function( elId ){
            tinymce.execCommand( 'mceAddEditor', false, elId );
            api.initParagraphsEditors.push( elId );
        };

        $(".sed-paragraph").livequery(function(){

            var elId = $(this).attr("sed_model_id") ,
                index = $.inArray( elId , api.initParagraphsEditors ) ,
                proccessing = false;

            if( !$( this ).attr( "id" ) ) {

                $( this ).attr("id" , elId );

            }

            if( index != -1 ){
                tinymce.execCommand( 'mceRemoveEditor', false, elId );
                api.initParagraphsEditors.splice( index , 1 );
            }

            var attrs = api.contentBuilder.getAttrs( elId );

            if( !_.isUndefined( attrs ) && !_.isUndefined( attrs.toolbar1 ) )
                $('[sed_model_id="' + elId + '"]').data("toolbar1" , attrs.toolbar1 );

            if( !_.isUndefined( attrs ) && !_.isUndefined( attrs.toolbar2 ) )
                $('[sed_model_id="' + elId + '"]').data("toolbar2" , attrs.toolbar2 );

                                                  //mouseout mouseenter
            $(this).on( "mouseover mousemove mouseenter" , function(){

                if( $.inArray( elId , api.initParagraphsEditors ) == -1 ){
                    proccessing = true;
                    _mceAddEditor( elId );
                    proccessing = false;
                }

            });

            $(this).click(function(e){

                if(api.appPreview.mode == "on")
                    return ;

                e.preventDefault();
                e.stopPropagation();

                var _isInit = function(){
                    if( $.inArray( elId , api.initParagraphsEditors ) == -1 ){
                        if( proccessing === true )
                            setTimeout( _isInit , 5);
                        else{
                            _mceAddEditor( elId );
                            tinymce.execCommand( 'mceFocus' , false , elId );
                        }

                    }else
                        tinymce.execCommand( 'mceFocus' , false , elId );
                };

                if( $.inArray( elId , api.initParagraphsEditors ) == -1 )
                    _isInit();

            });

        });

        api.siteIframe.textEditable( ".sed-paragraph" , "paragraph" );


    });


}(sedApp, jQuery));